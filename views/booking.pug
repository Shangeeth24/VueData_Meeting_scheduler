doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1.0")
    title Booking
    link(rel="stylesheet", href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css")
    //- link(rel="stylesheet", href="./styles.css")
  body(class="bg-dark d-flex align-items-center justify-content-center", style="min-height: 100vh; margin: 0;")
    div(class="bg-white rounded p-4 shadow", style="flex-wrap: wrap; display: flex;")
      div.col.p-3(id="card-id")
        h1 MEETING BOOKING
        form(id="bookingForm" onSubmit)
          div.mb-3
            //- label.form-label(for="meetingId") Meeting ID
            //- input#meetingId.form-control(type="number", name="meetingId")
          div.mb-3
            label.form-label(for="roomId") Room
            select#roomId.form-select(name="roomId")
    
          div.mb-3
            label.form-label(for="starttime") Start Time
            input#starttime.form-control(type="datetime-local", name="starttime" , required=true)
            label#startTimeError(for="startTimeError", style="color: red;")

          div.mb-3
            label.form-label(for="endtime") End Time
            input#endtime.form-control(type="datetime-local", name="endtime")
            label#endTimeError(for="endTimeError", style="color: red;")

          div.mb-3
            label.form-label(for="employeeId") Organizer Name
            select#employeeId.form-select(name="employeeId")
    
          div.row.gx-2.gy-3
            div.col
              button.btn.btn-primary.w-100(type="button", onclick="insertFunction()") Insert
         
            div.col
              button.btn.btn-primary.w-100(type="button", onclick="clearFunction()") Clear

    script.
      function clearFunction() {
        //- document.getElementById('meetingId').value = '';
        fetchRooms()
        fetchEmployees()
        document.getElementById('starttime').value = '';
        document.getElementById('endtime').value = '';
        document.getElementById('endTimeError').textContent = ''
        document.getElementById('startTimeError').textContent = ''
      }

      async function fetchRooms() {
        const response = await fetch('http://127.0.0.1:3112/getRooms');
        const rooms = await response.json();
        const selectElement = document.getElementById('roomId');
        while (selectElement.firstChild) {
          selectElement.removeChild(selectElement.firstChild);
        }

        rooms.forEach((room) => {
          const optionElement = document.createElement('option');
          optionElement.value = room.roomId;
          optionElement.textContent = room.room;
          selectElement.appendChild(optionElement);
        })
      }

      async function fetchEmployees() {
        const response = await fetch('http://127.0.0.1:3112/getEmployees');
        const employees = await response.json();
        const selectElement = document.getElementById('employeeId');
        while (selectElement.firstChild) {
          selectElement.removeChild(selectElement.firstChild);
        }
        employees.forEach((employee) => {
          const optionElement = document.createElement('option');
          optionElement.value = employee.employeeId;
          optionElement.textContent = employee.employeeId;
          selectElement.appendChild(optionElement);
          })
      }
       
 
      async function insertFunction() {
        if (!validateDateTime()) {
           return;
        }
        //- const meetingId = document.getElementById('meetingId').value;
        const roomId = document.getElementById('roomId').value;
        const startTime = document.getElementById('starttime').value;
        const endTime = document.getElementById('endtime').value;
        const employeeId = document.getElementById('employeeId').value;

        if(!startTime){
          document.getElementById('startTimeError').textContent = 'Start Time required';
          return;
        }
        if(!endTime){          
          document.getElementById('endTimeError').textContent = 'End Time required';
          document.getElementById('startTimeError').textContent = '';
          return;
        }

        const formData = {
          //- meetingId,
          roomId,
          startTime,
          endTime,
          employeeId
        };

        fetch("/insertBooking", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(formData),
        })
        .then(response => {
          if(response.status === 400) {
            return response.json().then(data => {
              document.getElementById('endTimeError').textContent = data.message;
              document.getElementById('startTimeError').textContent = '';
            })
          }
          clearFunction()
          return response.json();
          })
          .catch((error) => console.error('Error:', error));
      }
      
   
      function setMinDateTime() {
         const now = new Date();
         const year = now.getFullYear();
         const month = String(now.getMonth() + 1).padStart(2, '0');
         const day = String(now.getDate()).padStart(2, '0');
         const hour = String(now.getHours()).padStart(2, '0');
         const minute = String(now.getMinutes()).padStart(2, '0');
         const dateTime = `${year}-${month}-${day}T${hour}:${minute}`;
         document.getElementById('starttime').min = dateTime;
         document.getElementById('endtime').min = dateTime;
      }

      function validateDateTime() {
         const startTime = new Date(document.getElementById('starttime').value);
         const endTime = new Date(document.getElementById('endtime').value);
         if (endTime <= startTime) {
          document.getElementById('endTimeError').textContent = '';
          document.getElementById('startTimeError').textContent = '';
          document.getElementById('endTimeError').textContent = '"End time should be after start time."';
          return false;
         }
         const diffInHours = (endTime - startTime) / (1000 * 60 * 60);
         if (diffInHours > 30) {
          document.getElementById('endTimeError').textContent = '';
          document.getElementById('startTimeError').textContent = '';
          document.getElementById('endTimeError').textContent = "Meeting can't be more than 30 hours ";
          return false;
         }
         return true
      }
    

      window.onload = function(){
        setMinDateTime();
        fetchRooms();
        fetchEmployees();
      };